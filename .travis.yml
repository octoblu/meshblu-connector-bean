language: cpp
os:
- linux
- osx
addons:
  apt:
    sources:
    - ubuntu-toolchain-r-test
    packages:
    - g++-4.8
    - g++-4.8-multilib
    - gcc-multilib
    - build-essential
    - libbluetooth-dev
    - libudev-dev
    - libusb-1.0-0-dev
env:
  matrix:
  - PACKAGER_NODE_VERSION="5.5" PACKAGER_ARCH="amd64" MAIN_BUILD="true"
  - PACKAGER_NODE_VERSION="5.5" PACKAGER_ARCH="386"
matrix:
  exclude:
  - os: osx
    env: PACKAGER_NODE_VERSION="5.5" PACKAGER_ARCH="386"
branches:
  only:
  - "/^v[0-9]/"
before_install:
- PACKAGER_URL="https://meshblu-connector.octoblu.com/tools/packager/latest"
- curl -fsS "${PACKAGER_URL}/travis_install_node.sh" -o /tmp/travis_install_node.sh
- chmod +x /tmp/travis_install_node.sh
- ". /tmp/travis_install_node.sh"
- if [ "$TRAVIS_OS_NAME" == "linux" -a "$MAIN_BUILD" == "true" ]; then export NPM_PUBLISH="true"; fi
install:
- npm install --build-from-source
script:
- npm test
before_deploy:
- npm install --build-from-source --production
- npm install meshblu-connector-packager
- npm dedupe
- npm run package
deploy:
- provider: releases
  api_key:
    secure: "H6IrggaYwSRg5zBO0QV6xIvLkuR7Mz86AoYyAqyx5gbk1eqnmMJiEMHBp63xnICBZRTiQuqzY4sqr8AHs+wThNDKu7B5tSSTXDFcZC1PoQshsWP9tGacNY2Zgc7J5A7Y0irF3piFJm1wOftzaHRBtzz0ZrrSMcfhH5fN6M+pWA5WU0htwPzyvhpmFPya6lu1cUuC86wHxkJsJhpdrJe/G20ZQDdJIewPXM7QUwh8x+NLs7QLiJEfMGOvoX2Ymm5PHl5BCGkaZHyrGkMdQ/Lk7De4O1mr5ILbviUGuTpE+ScRx8OGacrsBvj37GUcjpj2hSj4e41+HCQdlN7JulSfry6odh72fsAkQosaFFJrzmac2BpZ/4du5HeI5UorXy6Qj0E//5IryP3OdGc2wo3yvSrapMNW6Nba3sAbu5PfWZTVikm2iST7nElYi5f65gGIPKud6j9c8mZw4phpCZznZinjZJcHPTHTTj6BeQqRhhDxbFqUE0XwMSJYN8j4+LOCutiDFZqjNpW7YKSH1GbDrwDaIjSx3Vif9wchqPkIgmaYTNb6nfEpCCbb5yU1cnOpd0ME92GzhWyRmGxYuY2DJWLMbmV4Q5U2DdLY6Uu/DGOhQPVQUuyTTrhZuN2IzM3jPNFsmh0aBsqM40U8B4A36RNKePwO7/55iYM5CyU+lZg="
  file_glob: true
  file:
  - "deploy/*"
  skip_cleanup: true
  on:
    tags: true
- provider: npm
  email: serveradmin@octoblu.com
  api_key:
    secure: "hNjcxygKPfY/Nw9KQXtERyjx9AWBTWQiCrpUjXccK+KTW83CIE8mAHYZiXO7ZLiMxgj35hB/mu85pravrupgGhkv/mMi8ryz9q4V4dRDg55lGO0XTEemX+ReLmdR5zIY9DKMN9YXHFnX5xtmf/IhsJ9QnJojNaVstA2R750XcQKJmVcnsI/u2wFWx0Z09/VxGK/HKm0kYJDUCVdOE19QQGVnyAyWV4208NCHP3jmByf1JhYkQbQXnD8eijdO8HqnE2Ss19+dalRtzc9PkYxH9oXUuKMgjDLz3ngMWCFBJPiNpptW8ABs/d5vu8OFJknPwoDOQ/AEDqSSulrIEjhdkdTSQZgfKQajCVCdV2Jotao3iOamGRxkVsSDnbQ416DKPtfVRYNeK+wksWk+oU20x2aKeGbVitjYOnLE5LdUNlAEH9omdexHchQYSvznk+dZRGLrdD4Eiy/zWApVmGx2G1tl12rH1ogS0ONbSIE/c65jAxgBv1qh8xWPZukb1sTMYkw9rRqcotyWoTeL5Q6exlpMQljUwwARXiGp78bgT8DKHj4KFHvNM+Mqutt91Z4YC2Tp6NHZXylc6JmTWPSr2xdn43WECbl/9UZv2E3t0Sd8pslKxoqHQ9Z7utHVrAX22vZOs2Lt9d9grdnxHWMvK60u/kT7g3PDG6RDpXV1ldY="
  on:
    tags: true
    condition: "$NPM_PUBLISH = true"
